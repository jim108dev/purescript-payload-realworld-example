// Generated by purs version 0.13.8
"use strict";
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Monad_Error_Class = require("../Control.Monad.Error.Class/index.js");
var Data_Array = require("../Data.Array/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Show = require("../Data.Show/index.js");
var Data_Symbol = require("../Data.Symbol/index.js");
var Database_Postgres = require("../Database.Postgres/index.js");
var Database_Postgres_SqlValue = require("../Database.Postgres.SqlValue/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Effect_Exception = require("../Effect.Exception/index.js");
var Server_Profile_Type_Misc = require("../Server.Profile.Type.Misc/index.js");
var Server_Shared_Persistence_Postgres_Query = require("../Server.Shared.Persistence.Postgres.Query/index.js");
var Shared_Type_LongString = require("../Shared.Type.LongString/index.js");
var Shared_Type_ShortString = require("../Shared.Type.ShortString/index.js");
var Simple_JSON = require("../Simple.JSON/index.js");
var validate = function (result) {
    if (result instanceof Data_Either.Left) {
        if (result.value0 instanceof Server_Shared_Persistence_Postgres_Query.IntegrityError) {
            if (result.value0.value0.constraint === "follower_not_followee") {
                return Control_Applicative.pure(Effect_Aff.applicativeAff)(new Data_Either.Left(Server_Profile_Type_Misc.FOLLOWER_EQUALS_FOLLOWEE.value));
            };
            if (result.value0.value0.constraint === "following_unique") {
                return Control_Applicative.pure(Effect_Aff.applicativeAff)(new Data_Either.Left(Server_Profile_Type_Misc.FOLLOWING_EXISTS.value));
            };
            return Control_Monad_Error_Class.throwError(Effect_Aff.monadThrowAff)(Effect_Exception.error(Data_Show.show(Server_Shared_Persistence_Postgres_Query.showPGError)(result.value0)));
        };
        return Control_Monad_Error_Class.throwError(Effect_Aff.monadThrowAff)(Effect_Exception.error(Data_Show.show(Server_Shared_Persistence_Postgres_Query.showPGError)(result.value0)));
    };
    if (result instanceof Data_Either.Right) {
        var v = Data_Array.head(result.value0);
        if (v instanceof Data_Maybe.Nothing) {
            return Control_Applicative.pure(Effect_Aff.applicativeAff)(new Data_Either.Left(Server_Profile_Type_Misc.NOT_FOUND.value));
        };
        if (v instanceof Data_Maybe.Just) {
            return Control_Applicative.pure(Effect_Aff.applicativeAff)(new Data_Either.Right(v.value0));
        };
        throw new Error("Failed pattern match at Server.Profile.Persistence.Postgres (line 104, column 19 - line 106, column 35): " + [ v.constructor.name ]);
    };
    throw new Error("Failed pattern match at Server.Profile.Persistence.Postgres (line 97, column 3 - line 106, column 35): " + [ result.constructor.name ]);
};
var insertFollower = function (pool) {
    return function (followerId) {
        return function (followeeUsername) {
            return Database_Postgres.withClient(pool)(function (conn) {
                return Control_Bind.bind(Effect_Aff.bindAff)(Server_Shared_Persistence_Postgres_Query.query(Server_Shared_Persistence_Postgres_Query.readJson(Simple_JSON.readRecord()(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "bio";
                }))(Simple_JSON.readMaybe(Shared_Type_LongString.readForeignLongString))(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "following";
                }))(Simple_JSON.readBoolean)(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "image";
                }))(Simple_JSON.readMaybe(Shared_Type_LongString.readForeignLongString))(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "username";
                }))(Shared_Type_ShortString.readForeignShortString)(Simple_JSON.readFieldsNil)()())()())()())()())))("\x0aWITH inserted AS (\x0aINSERT INTO FOLLOWING (follower_id, followee_id)\x0a  SELECT\x0a    $1,\x0a    followee.id\x0a  FROM\x0a    \"user\" AS followee\x0a  WHERE\x0a    followee.username = $2\x0a  RETURNING\x0a    *\x0a)\x0aSELECT\x0a  followee.*,\x0a  TRUE AS FOLLOWING\x0aFROM\x0a  \"user\" AS followee,\x0a  inserted\x0aWHERE\x0a  id = inserted.followee_id")([ Server_Shared_Persistence_Postgres_Query.p_(Database_Postgres_SqlValue.isSqlValueInt)(followerId), Server_Shared_Persistence_Postgres_Query.p_(Shared_Type_ShortString.isSqlValueShortString)(followeeUsername) ])(conn))(validate);
            });
        };
    };
};
var findFollowee = function (pool) {
    return function (followerId) {
        return function (followeeUsername) {
            return Database_Postgres.withClient(pool)(function (conn) {
                return Control_Bind.bind(Effect_Aff.bindAff)(Server_Shared_Persistence_Postgres_Query.query(Server_Shared_Persistence_Postgres_Query.readJson(Simple_JSON.readRecord()(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "bio";
                }))(Simple_JSON.readMaybe(Shared_Type_LongString.readForeignLongString))(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "following";
                }))(Simple_JSON.readBoolean)(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "image";
                }))(Simple_JSON.readMaybe(Shared_Type_LongString.readForeignLongString))(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "username";
                }))(Shared_Type_ShortString.readForeignShortString)(Simple_JSON.readFieldsNil)()())()())()())()())))("\x0aSELECT\x0a  followee.*,\x0a  follower_id IS NOT NULL AS FOLLOWING\x0aFROM\x0a  \"user\" AS followee\x0a  LEFT JOIN FOLLOWING ON (followee.id = followee_id)\x0a  LEFT JOIN \"user\" AS follower ON (follower.id = $1)\x0aWHERE\x0a  followee.username = $2")([ Server_Shared_Persistence_Postgres_Query.p_(Database_Postgres_SqlValue.isSqlValueMaybe(Database_Postgres_SqlValue.isSqlValueInt))(followerId), Server_Shared_Persistence_Postgres_Query.p_(Shared_Type_ShortString.isSqlValueShortString)(followeeUsername) ])(conn))(validate);
            });
        };
    };
};
var deleteFollower = function (pool) {
    return function (followerId) {
        return function (followeeUsername) {
            return Database_Postgres.withClient(pool)(function (conn) {
                return Control_Bind.bind(Effect_Aff.bindAff)(Server_Shared_Persistence_Postgres_Query.query(Server_Shared_Persistence_Postgres_Query.readJson(Simple_JSON.readRecord()(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "bio";
                }))(Simple_JSON.readMaybe(Shared_Type_LongString.readForeignLongString))(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "following";
                }))(Simple_JSON.readBoolean)(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "image";
                }))(Simple_JSON.readMaybe(Shared_Type_LongString.readForeignLongString))(Simple_JSON.readFieldsCons(new Data_Symbol.IsSymbol(function () {
                    return "username";
                }))(Shared_Type_ShortString.readForeignShortString)(Simple_JSON.readFieldsNil)()())()())()())()())))("\x0aDELETE FROM FOLLOWING USING \"user\" AS followee\x0aWHERE follower_id = $1\x0a  AND followee.username = $2\x0a  AND followee_id = followee.id\x0aRETURNING\x0a  followee.*,\x0a  FALSE AS FOLLOWING")([ Server_Shared_Persistence_Postgres_Query.p_(Database_Postgres_SqlValue.isSqlValueInt)(followerId), Server_Shared_Persistence_Postgres_Query.p_(Shared_Type_ShortString.isSqlValueShortString)(followeeUsername) ])(conn))(validate);
            });
        };
    };
};
var mkHandle = function (p) {
    return {
        findFollowee: findFollowee(p),
        insertFollower: insertFollower(p),
        deleteFollower: deleteFollower(p)
    };
};
module.exports = {
    mkHandle: mkHandle,
    findFollowee: findFollowee,
    insertFollower: insertFollower,
    deleteFollower: deleteFollower,
    validate: validate
};
