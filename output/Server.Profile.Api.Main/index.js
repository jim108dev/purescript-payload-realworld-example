// Generated by purs version 0.13.8
"use strict";
var Data_Bifunctor = require("../Data.Bifunctor/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Payload_Server_Response = require("../Payload.Server.Response/index.js");
var Server_Profile_Api_Type_Misc = require("../Server.Profile.Api.Type.Misc/index.js");
var Server_Profile_Persistence_Postgres = require("../Server.Profile.Persistence.Postgres/index.js");
var Server_Profile_Type_Misc = require("../Server.Profile.Type.Misc/index.js");
var Server_Shared_Api_Main = require("../Server.Shared.Api.Main/index.js");
var renderError = function (v) {
    if (v instanceof Server_Profile_Type_Misc.NOT_FOUND) {
        return Payload_Server_Response.notFound(Server_Shared_Api_Main.renderErrorMessage("profile not found"));
    };
    if (v instanceof Server_Profile_Type_Misc.FOLLOWER_EQUALS_FOLLOWEE) {
        return Payload_Server_Response.unprocessableEntity(Server_Shared_Api_Main.renderErrorMessage("follower must be different from followee"));
    };
    if (v instanceof Server_Profile_Type_Misc.FOLLOWING_EXISTS) {
        return Payload_Server_Response.unprocessableEntity(Server_Shared_Api_Main.renderErrorMessage("already following"));
    };
    throw new Error("Failed pattern match at Server.Profile.Api.Main (line 48, column 1 - line 48, column 45): " + [ v.constructor.name ]);
};
var next = function (h) {
    return Server_Profile_Persistence_Postgres.mkHandle(h.pool.value0);
};
var unfollow = function (h) {
    return function (v) {
        return Data_Functor.map(Effect_Aff.functorAff)(Data_Functor.map(Data_Functor.functorFn)(Server_Shared_Api_Main.setHeaders(v.guards.origin))(Data_Bifunctor.bimap(Data_Either.bifunctorEither)(renderError)(function ($19) {
            return Payload_Server_Response.ok(Server_Profile_Api_Type_Misc.mkDto($19));
        })))((next(h)).deleteFollower(v.guards.userId)(v.params.username));
    };
};
var get = function (h) {
    return function (v) {
        return Data_Functor.map(Effect_Aff.functorAff)(Data_Functor.map(Data_Functor.functorFn)(Server_Shared_Api_Main.setHeaders(v.guards.origin))(Data_Bifunctor.bimap(Data_Either.bifunctorEither)(renderError)(function ($20) {
            return Payload_Server_Response.ok(Server_Profile_Api_Type_Misc.mkDto($20));
        })))((next(h)).findFollowee(v.guards.maybeUserId)(v.params.username));
    };
};
var follow = function (h) {
    return function (v) {
        return Data_Functor.map(Effect_Aff.functorAff)(Data_Functor.map(Data_Functor.functorFn)(Server_Shared_Api_Main.setHeaders(v.guards.origin))(Data_Bifunctor.bimap(Data_Either.bifunctorEither)(renderError)(function ($21) {
            return Payload_Server_Response.ok(Server_Profile_Api_Type_Misc.mkDto($21));
        })))((next(h)).insertFollower(v.guards.userId)(v.params.username));
    };
};
var mkHandle = function (h) {
    return {
        byUsername: {
            get: get(h),
            follow: follow(h),
            unfollow: unfollow(h)
        }
    };
};
module.exports = {
    mkHandle: mkHandle,
    next: next,
    get: get,
    follow: follow,
    unfollow: unfollow,
    renderError: renderError
};
