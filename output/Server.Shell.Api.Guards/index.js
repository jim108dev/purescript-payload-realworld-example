// Generated by purs version 0.13.8
"use strict";
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Error_Util = require("../Control.Error.Util/index.js");
var Control_Monad_Maybe_Trans = require("../Control.Monad.Maybe.Trans/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_String_Common = require("../Data.String.Common/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Payload_Headers = require("../Payload.Headers/index.js");
var Payload_Server_Guards = require("../Payload.Server.Guards/index.js");
var Payload_Server_Response = require("../Payload.Server.Response/index.js");
var Server_Shared_Api_Main = require("../Server.Shared.Api.Main/index.js");
var authUser = function (h) {
    return function (req) {
        return Data_Functor.mapFlipped(Effect_Aff.functorAff)(Control_Monad_Maybe_Trans.runMaybeT(Control_Bind.bind(Control_Monad_Maybe_Trans.bindMaybeT(Effect_Aff.monadAff))(Control_Monad_Maybe_Trans.MaybeT(Data_Functor.map(Effect_Aff.functorAff)(Payload_Headers.lookup("authorization"))(Payload_Server_Guards.headers(req))))(function (str) {
            return Control_Bind.bind(Control_Monad_Maybe_Trans.bindMaybeT(Effect_Aff.monadAff))(Control_Monad_Maybe_Trans.MaybeT(Control_Applicative.pure(Effect_Aff.applicativeAff)(Data_Maybe.Just.create(Data_String_Common.replace("Bearer ")("")(str)))))(function (inter) {
                return Control_Bind.bind(Control_Monad_Maybe_Trans.bindMaybeT(Effect_Aff.monadAff))(Control_Monad_Maybe_Trans.MaybeT(Control_Applicative.pure(Effect_Aff.applicativeAff)(Data_Maybe.Just.create(Data_String_Common.replace("Token ")("")(inter)))))(function (token) {
                    return Control_Bind.bind(Control_Monad_Maybe_Trans.bindMaybeT(Effect_Aff.monadAff))(Control_Monad_Maybe_Trans.MaybeT(h.decode(token)))(function (id) {
                        return Control_Applicative.pure(Control_Monad_Maybe_Trans.applicativeMaybeT(Effect_Aff.monadAff))(id);
                    });
                });
            });
        })))(Control_Error_Util.note(Payload_Server_Response.unauthorized(Server_Shared_Api_Main.renderErrorMessage("Invalid token"))));
    };
};
var maybeAuthUser = function (h) {
    return function (req) {
        return Control_Bind.bind(Effect_Aff.bindAff)(authUser(h)(req))(function (v) {
            if (v instanceof Data_Either.Left) {
                return Control_Applicative.pure(Effect_Aff.applicativeAff)(new Data_Either.Right(Data_Maybe.Nothing.value));
            };
            if (v instanceof Data_Either.Right) {
                return Control_Applicative.pure(Effect_Aff.applicativeAff)(Data_Either.Right.create(new Data_Maybe.Just(v.value0)));
            };
            throw new Error("Failed pattern match at Server.Shell.Api.Guards (line 35, column 9 - line 37, column 41): " + [ v.constructor.name ]);
        });
    };
};
var authOrigin = function (req) {
    return Data_Functor.mapFlipped(Effect_Aff.functorAff)(Data_Functor.map(Effect_Aff.functorAff)(Payload_Headers.lookup("origin"))(Payload_Server_Guards.headers(req)))(Control_Error_Util.note(Payload_Server_Response.unauthorized(Server_Shared_Api_Main.renderErrorMessage("Origin missing"))));
};
var mkHandle = function (h) {
    return {
        userId: authUser(h),
        maybeUserId: maybeAuthUser(h),
        origin: authOrigin
    };
};
module.exports = {
    mkHandle: mkHandle,
    maybeAuthUser: maybeAuthUser,
    authUser: authUser,
    authOrigin: authOrigin
};
